# Natural-Language SQL Query Generator

Command-line tool that converts natural-language questions into safe `SELECT` queries using an LLM, validates them, and runs them against a SQL Server database (or prints SQL only with `--dry-run`).

## Features

- **Multi-provider LLM**: OpenAI, DeepSeek, Claude, Ollama (configurable via env)
- **Two-step LLM flow**: (1) Select relevant tables from descriptions, (2) Generate SQL from schema
- **Validation**: SELECT-only, no injection patterns, forbidden columns blocked, structural checks (sqlparse)
- **Limit enforcement**: Row limit (e.g. 500) and optional LLM rewrite for `TOP (n)`
- **Structured logging**: JSON logs with `request_id`, `user_input`, `tables_selected`, `generated_sql`, etc.
- **Retries**: 3 attempts with exponential backoff for LLM calls

## Project structure

```
project/
├── cli/           # CLI and main pipeline
├── llm/            # LLM abstraction (litellm)
├── prompts/        # Prompt templates and manager
├── validation/     # Query validation (SELECT, injection, forbidden columns)
├── execution/      # Query execution and result renderer
├── app_logging/    # Structured logging (renamed from logging to avoid stdlib shadowing)
├── config/         # YAML + env config
├── schema/         # Table descriptions + compressed schema loader
├── config.yaml
├── forbid-columns.txt
├── main.py
└── query-cli       # Convenience entry script
```

## Setup

1. **Create a virtual environment and install dependencies**

   ```bash
   python3 -m venv .venv
   source .venv/bin/activate   # or .venv\Scripts\activate on Windows
   pip install -r requirements.txt
   ```

2. **Schema and table descriptions**

   - `lifecore-tables-description.txt` – table names, descriptions, and dependencies (used for table selection).
   - `lifecore-compressed` – column-level schema (generated by `compress_schema.py` from `lifecore.sql`).

3. **Configuration**

   - Copy or edit `config/config.yaml` (paths, DB, LLM, `max_rows`, timeouts).
   - Environment variables override YAML (e.g. `LLM_PROVIDER`, `LLM_MODEL`, `OPENAI_API_KEY`, `DB_SERVER`, `DB_PASSWORD`).

4. **Forbidden columns**

   - Edit `forbid-columns.txt`: one column per line, format `Schema.Table.Column` or `Table.Column`. Lines starting with `#` are ignored.

5. **LLM provider**

   - **OpenAI**: set `OPENAI_API_KEY` (and optionally `LLM_PROVIDER=openai`, `LLM_MODEL=gpt-4o-mini`).
   - **Ollama**: set `LLM_PROVIDER=ollama`, `LLM_MODEL=llama2` (and optionally `OLLAMA_BASE_URL=http://localhost:11434`).

6. **Database (for execution)**

   - Set connection in config or env (`DB_SERVER`, `DB_DATABASE`, `DB_USER`, `DB_PASSWORD`, or `DB_CONNECTION_STRING`).
   - Install ODBC driver for SQL Server and `pyodbc` (included in `requirements.txt`).

## Usage

```bash
# With venv active:
python main.py "Show active users created last week"
python main.py --dry-run "List accounting documents from last month"   # Only print generated SQL
python main.py -v "Count proposals by status"   # Verbose (DEBUG) logging
```

Or use the convenience script:

```bash
./query-cli "Show accounting documents from last week"
```

## Data flow

1. **User input** (natural language)
2. **LLM 1**: Table selection (from `lifecore-tables-description.txt`)
3. **Load schema** for selected tables from `lifecore-compressed`
4. **LLM 2**: Generate a single `SELECT` query
5. **Validation**: SELECT-only, no injection, no forbidden columns, syntax (sqlparse)
6. **LLM 3** (optional): Rewrite query with row limit (e.g. `TOP (500)`)
7. **Re-validate** and **execute** (or **dry-run**)
8. **Render** results (rich table) and **log** (structured JSON)

## Security

- Only `SELECT` is allowed; validation rejects multiple statements and dangerous patterns.
- Forbidden columns are blocked in validation and can be double-checked via an optional LLM security prompt.
- Use a **read-only** database user in production.
- Sensitive data (e.g. passwords, SSN) should be listed in `forbid-columns.txt`.

## License

Use as needed for the project.
